<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/elements/behaviors/button-listeners.html">
<link rel="import" href="/elements/behaviors/multi-platform.html">
<link rel="import" href="/elements/behaviors/ui-helper.html">

<dom-module id="page-editor">

<template>
  <main class="layout vertical fit">
    <paper-material elevation="1" class="containerBox">
      <!-- photo -->
      <div id="attachPhoto" class="photoBox">
        <iron-image id="cameraImage" src="[[imageSource]]" sizing="cover"></iron-image>
        <paper-fab id="cameraButton" icon="image:photo-camera"></paper-fab>
        <paper-fab id="discardPhotoButton" icon="cancel"></paper-fab>
      </div>
      <!-- select -->
      <div id="selectTo" class="selectBox" hidden>
        <p class="label"><strong>To</strong></p>
        <iron-ajax url="/_api/contacts" last-response="{{listData}}" on-response="_onResponseReceived"></iron-ajax>
        <select class="fill" multiple>
          <!-- <option value="all">All</option> -->
          <template is="dom-repeat" items="{{listData.rows}}" as="item" on-dom-change="_onOptionsBound">
            <option value="[[item.doc._id]]">[[item.doc.username]]</option>
          </template>
        </select>
      </div>
    </paper-material>

    <!-- message -->
    <textarea id="textbox" class="postcard flex" value="{{editText::input}}" placeholder="Message" on-focus="shouldFocusWithoutScrollUp"></textarea>
  </main>
</template>

<script>
'use strict';
Polymer({
  is: "page-editor",
  behaviors: [
      PageBehaviors.ButtonListeners,
      PageBehaviors.MultiPlatform,
      PageBehaviors.UIHelper
    ],
  properties: {
    editText: {
      type: String,
      value: ""
    },
    backButton: Object,
    saveButton: Object,
    cameraButton: Object,
    discardPhotoButton: Object,
    cameraImageData: {
      type: String,
      notify: true
    },
    imageSource: {
      type: String,
      computed: 'getImageSource(cameraImageData)'
    },
    pixelData: "R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
    textBox: Object,
    editDoc: Object,
    listData: {
      type: Object,
      notify: true
    },
    isEdit: false
  },
  listeners: {
    'camera-success': 'onCameraSuccess',
    'camera-error': 'onCameraError'
  },
  created: function() {
    console.log(this.localName + ' was created');
  },
  ready : function() {
    console.log(this.localName + ' ready');
  },
  attached: function() {
    console.log(this.localName + ' was attached');
  },
  detached: function() {
    console.log(this.localName + ' was detached');
  },
  viewWillAppear: function(id) {
    console.log(this.localName + ' viewWillAppear: ' + id);
    this.activate();
    if(myApp.discoverButton) {
      myApp.discoverButton.removeAttribute("hidden");
    }

    // reset image
    this.resetImageSource();

    if(id === "new"){
      // new message
      myApp.title = "New Postcard";
      this.isEdit = false;
      this.editText = "";
      this.autoFocus(this.textBox); // UX send autofocus to textarea
    } else {
      // edit message
      myApp.title = "Edit Postcard";
      this.isEdit = true;
      this._getCard(id);
      this.shouldFocus(this.textBox); // UX send autofocus to textarea
    }
    this._reloadContacts(); // reload contacts
  },
  viewWillDisappear: function() {
    console.log(this.localName + ' viewWillDisappear');
    this.deactivate();
    this.editDoc = null; // reset edit doc
    this._resetView();
    document.activeElement.blur(); // reset text input cursor
  },
  activate: function() {
    console.log(this.localName + " activate... active status:" + this._isActivated);

    // local scope
    this.textBox = this.querySelector("textarea");
    this.cameraButton = this.querySelector("#cameraButton");
    this.discardPhotoButton = this.querySelector("#discardPhotoButton");

    // document scope
    this.backButton = document.querySelector("#backButton");
    this.saveButton = document.querySelector("#saveButton");

    var toolbarButtonArray = [this.backButton, this.saveButton, this.cameraButton, this.discardPhotoButton];
    var toolbarFunctionArray = [this._backButtonHandler, this._saveButtonHandler.bind(this), this._cameraButtonHandler.bind(this), this._discardPhotoButtonHandler.bind(this)];
    this.activateButtons(toolbarButtonArray, toolbarFunctionArray);
  },
  deactivate: function() {
    console.log(this.localName + " deactivate... active status:" + this._isActivated);
    this.deactivateButtons([this.backButton, this.saveButton]);
  },
  _backButtonHandler: function(routeDestination) {
    console.log("<- don't save and go back to:" + routeDestination);
    getURL("home");
  },
  _saveButtonHandler: function(e) {
    if(this.editText.length == 0) {
      console.log("Please enter a message");
      alert("Please enter a message"); // notify user
      this.shouldFocus(this.textBox); // UX send focus to textarea
      return;
    }

    // go back after saving...
    if(!this.editDoc) {
      console.log("Save new message:" + this.editText);
      this.createItem(this.editText, this.cameraImageData);
    } else {
      console.log("Save edited message:" + this.editText);
      this.updateItem(this.editDoc._id, this.editText, this.cameraImageData);
    }
  },

  // Note:
  // Cordova functions cannot be called directly from inside an iframe.
  // On mobile the Cordova webview origin is file://
  // but the origin of iframe running JXcore Express app is http://localhost
  // Cordova functions are therefore triggered using Cross Origin Messaging.
  _cameraButtonHandler: function(e) {
    // Desktop
    if (IS_MOCKMOBILE) {
      navigator.camera.getPicture( this._cameraSuccess.bind(this), this._cameraError.bind(this) );
      return;
    }
    // Mobile targetOrigin is 'file://'
    parent.postMessage('navigator.camera.getPicture', 'file://');
  },
  _cameraSuccess: function(imageData) {
    console.log("Camera imageData loaded");
    this._setCameraImageData(imageData);
  },
  _cameraError: function(message) {
    // alert() warpped in setTimeout because of iOS image picker quirk
    setTimeout(function() {
      alert('Camera error: ' + message);
    }, 0);
  },

  // handle Camera events fired from Cordova webview
  onCameraSuccess: function(e) {
    console.log("onCameraSuccess event");
    console.log(e);
    if (e.detail) {
      this._cameraSuccess(e.detail);
    }
  },
  onCameraError: function(e) {
    console.log("onCameraError event");
    console.log(e);
    if (e.detail) {
      this._cameraError(e.detail);
    }
  },

  getImageSource: function(imageData) {
    if (typeof imageData !== 'undefined') {
      return "data:image/jpeg;base64," + imageData;
    }
    return "data:image/gif;base64," + 
      "R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
  },

  _setCameraImageData: function(imageData) {
    this.cameraImageData = imageData;
    this._updateButtonsWithPhoto(true);
  },

  resetImageSource: function() {
    this.cameraImageData = this.pixelData; // reset to 1px spacer image
    this._updateButtonsWithPhoto(false);
  },

  _discardPhotoButtonHandler: function(e) {
    console.log("Remove photo...");
    this.resetImageSource();
  },

  _updateButtonsWithPhoto: function(isPhotoCaptured) {
    if(isPhotoCaptured) {
      console.log("x Photo");
      this.hide(this.cameraButton);
      this.show(this.discardPhotoButton);
    } else {
      console.log("+ Photo");
      this.show(this.cameraButton);
      this.hide(this.discardPhotoButton);
    }
  },

  _getCard: function(index) {
    var doc = document.querySelector("page-home").get('listData.rows.'+index+'.doc');
    if(doc && doc._id && doc.text) {
      this.editText = doc.text;
      this.editDoc = doc;
      var filename = doc._id + '.jpg';
      if (doc._attachments && doc._attachments[filename]) {
        var imageData = doc._attachments[filename].data;
        if (typeof imageData !== 'undefined') {
          this._setCameraImageData(imageData);
        }
      }
    } else {
      console.log("Error looking up doc object at index:",index);
    }
  },

  // create item
  createItem: function(text, imageData) {
    var cardId = generatePostcardId(); //generateUUID();
    console.log("+ Create item:" + text + " id:"+ cardId);
    this._saveCard(cardId, myApp.username, text, imageData);
  },
  // update item
  updateItem: function(cardId, text, imageData) {
    console.log("+ Edit item:" + text + " id:"+ cardId);
    this._saveCard(cardId, myApp.username, text, imageData);
  },
  // note: any changes to data will need updated in the api.js
  _saveCard: function(cardId, author, text, imageData) {
    var toArray = this._getSelectedContacts();
    console.log("=> Save item:" + text + " id:"+ cardId + " by:"+ author + " to:" + toArray.length);
    console.log(toArray);
    var attachments;
    if ( imageData && imageData.length > 64 ) {
      var filename = cardId + '.jpg'; // using postcard id as image filename
      attachments = {};
      attachments[filename] = {
        content_type: 'image/jpeg',
        data: imageData
      };
      console.log(attachments);
    }
    $.ajax({
        url: myApp.api + "cards/" + cardId,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
          from: author,
          text: text,
          to: toArray,
          attachments: attachments
        }),
        dataType: 'json',
        error: function(jqXHR, textStatus, errorThrown) {
          console.log('@ error in save Card ' + JSON.stringify(jqXHR) + ' ' + textStatus + ' ' + errorThrown);
          alert("Error saving card");
        },
        success: function(data, textStatus, jqXHR) {
          console.log("@ saved Card - " + textStatus);
          console.log(data);
          // if 'ok' update client UI else alert user with error
          if(data.ok && data.ok===true) {
            console.log("OK",textStatus);
            getURL("home"); // go back once doc and attachments are saved and ready
          } else {
            alert("Save card error");
          }
        }
    });
  },

  // iron-ajax request
  _reloadContacts: function() {
    var ironAjax = this.querySelector("iron-ajax");
    if(ironAjax){
        console.log("load contacts data");
        ironAjax.generateRequest();
    }
  },

  // iron-ajax response
  _onResponseReceived: function () {
      console.log("_onResponseReceived");
      console.log(this.listData);

      if(!this.listData || !this.listData.rows || this.listData.total_rows==0 ) {
        console.log("Error no records found.");
        return;
      }

      console.log("listData offset:" + this.listData.offset + " total_rows:" + this.listData.total_rows );

      // splice out 'me' record (doesn't exist here yet)
      /*
      if(this.listData.rows.length>0) {
        var row;
        for(var i=0; i<this.listData.rows.length; i++) {
          row = this.listData.rows[i];
          if(row.id === 'me') {
            console.log("me:" + row.doc.user);
            this.splice('listData.rows',i,1);
            break;
          }
        }
      }
      //*/

      //sort records by username
      this.set('listData.rows', _.sortBy(this.listData.rows, function(o){
        return o.doc.username;
      }));

      // note: _updateSelection will be called when option elements are bound
  },

  _getSelectedContacts : function() {
    var toArray = [];
    var options = this.querySelectorAll("option"), i = options.length;
    while (i--) {
      var option = options[i];
      if (option.selected && option.value !== "all") {
        toArray.push(option.value);
      }
    }
    console.log("Selected contacts: " + toArray.length);
    return toArray;
  },

/*
  _selectAll : function() {
    this.querySelector('option[value="all"]').setAttribute('selected', true);
    this._changed('all');
  },
  _onChanged : function(e) {
    var value = e.target.value;
    console.log("user selected option value:" + value );
    this._changed(value);
  },
  _changed : function(value) {
    var options = this.querySelectorAll("option"), i = options.length;
    var optionAll = options[0];
    if (value === 'all') {
      console.log("Select all");
      while (i--) {
        var option = options[i];
        option.selected = true;
      }
    }
  },
//*/

  // if editing we need to match postcard's 'to' list of pks against private address book pks
  _updateSelection : function() {
    var i = this.listData.rows.length; // total number of saved contacts
    console.log("contact options: " + i);
    // show selectTo element if contacts available
    if(i>0) {
      this.showSelector("#selectTo");
    }
    while (i--) {
      var item = this.listData.rows[i];
      if (!this.editDoc || !this.editDoc.to || !Array.isArray(this.editDoc.to)) {
        break;
      }
      if ( this.editDoc.to.indexOf(item.doc._id) > -1 ) {
        console.log("select option: " + item.doc.username + " id:" + item.doc._id);
        var option = this.querySelector('option[value="'+item.doc._id+'"]');
        option.selected = true;
      }
    }
  },

  _clearSelection : function() {
    var options = this.querySelectorAll('option'), i = options.length;
    while (i--) {
      var option = options[i];
      option.selected = false;
    }
  },

  _resetView : function() {
    this.hideSelector("#selectTo");
    this._clearSelection(); // reset selection
  },

  _onOptionsBound : function() {
    console.log("<option> elements bound");
    this._updateSelection();
  }

});
</script>
</dom-module>
