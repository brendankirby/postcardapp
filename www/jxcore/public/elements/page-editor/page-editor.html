<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/elements/behaviors/button-listeners.html">
<link rel="import" href="/elements/behaviors/multi-platform.html">

<dom-module id="page-editor">

<template>
  <textarea id="textbox" class="postcard flex" value="{{editText::input}}" placeholder="Message" on-focus="shouldFocusWithoutScrollUp"></textarea>
</template>

<script>
Polymer({
  is: "page-editor",
  behaviors: [
      PageBehaviors.ButtonListeners,
      PageBehaviors.MultiPlatform
    ],
  properties: {
    editText: {
      type: String,
      value: "",
    },
    backButton: Object,
    saveButton: Object,
    textBox: Object,
    editDoc: Object
  },
  created: function() {
    console.log(this.localName + ' was created');
  },
  ready : function() {
    console.log(this.localName + ' ready');
  },
  attached: function() {
    console.log(this.localName + ' was attached');
  },
  detached: function() {
    console.log(this.localName + ' was detached');
  },
  viewWillAppear: function(id) {
    console.log(this.localName + ' viewWillAppear: ' + id);
    this.activate();
    
    if(id === "new"){
      // new message 
      myApp.title = "New Postcard";
      this.editText = "";
      this.autoFocus(this.textBox); // UX send autofocus to textarea
    } else {
      // edit message 
      myApp.title = "Edit Postcard";
      this._getCard(id);
      this.shouldFocus(this.textBox); // UX send autofocus to textarea
    }
  },
  viewWillDisappear: function() {
    console.log(this.localName + ' viewWillDisappear');
    this.deactivate();
    this.editDoc = null; // reset edit doc
    document.activeElement.blur(); // reset text input cursor
  },
  activate: function() {
    console.log(this.localName + " activate... active status:" + this._isActivated);
    
    // local scope
    this.textBox = this.querySelector("textarea");

    // document scope
    this.backButton = document.querySelector("#backButton");
    this.saveButton = document.querySelector("#saveButton");

    var toolbarButtonArray = [this.backButton, this.saveButton];
    var toolbarFunctionArray = [this._backButtonHandler, this._saveButtonHandler.bind(this)];
    this.activateButtons(toolbarButtonArray, toolbarFunctionArray);
    
    this._useFullHeight("textarea"); // NB: only use with standard textarea
  },
  deactivate: function() {
    console.log(this.localName + " deactivate... active status:" + this._isActivated);
    this.deactivateButtons([this.backButton, this.saveButton]);
  },
  _backButtonHandler: function(routeDestination) {
    console.log("<- don't save and go back to:" + routeDestination);
    getURL("home");
  },
  _saveButtonHandler: function(e) {
    if(this.editText.length == 0) {
      console.log("Please enter a message");
      alert("Please enter a message"); // notify user
      this.shouldFocus(this.textBox); // UX send focus to textarea
      return;
    }
    if(!this.editDoc) {
      console.log("save new message:" + this.editText);
      // get reference to page and call the createItem method
      document.querySelector("page-home").createItem(this.editText);
    } else {
      console.log("save edited message:" + this.editText);
      // get reference to page and call the updateItem method
      document.querySelector("page-home").updateItem(this.editText, this.editDoc._id);
    }
    
    // go back 
    getURL("home");
  },
  _getCard: function(index) {
    var doc = document.querySelector("page-home").get('listData.rows.'+index+'.doc');
    if(doc && doc._id && doc.content) {
      this.editText = doc.content;
      this.editDoc = doc;
    } else {
      console.log("Error looking up doc object at index:",index);
    }
  },
  _useFullHeight: function(selector) {
    var element = this.querySelector(selector);
    if(element){
      console.log('useFullHeight');
      var h = window.innerHeight;
      var y = document.getElementById('mainToolbar').offsetHeight + document.getElementById('dropShadow').offsetHeight;
      var remainingHeight = h - y;
      console.log("remainingHeight = " + remainingHeight + " --y:"+y);
      element.style.height = remainingHeight+'px';
    } else {
      console.log('useFullHeight did not get an element "' + selector +'"');
    }
  }
});
</script>
</dom-module>
