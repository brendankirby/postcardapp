<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="/bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="/elements/behaviors/tree-traversing.html">
<link rel="import" href="/elements/behaviors/ui-helper.html">

<dom-module id="modal-identity">
<style>
/*:host { display: none; }*/
</style>

<template>
  <paper-header-panel>
    <paper-toolbar>
      <div id="leftToolbarButtons">
        <paper-icon-button id="backButton" icon="arrow-back" on-tap ="_onBackHandler" hidden></paper-icon-button>
      </div>
      <div id="appName">[[title]]</div>
      <div id="rightToolbarButtons">
        <paper-icon-button id="closeButton" icon="close" dialog-dismiss></paper-icon-button>
      </div>
    </paper-toolbar>

    <!-- modal pages -->
  	<neon-animated-pages class="fit" selected="{{selectedPage}}" attr-for-selected="id" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation" on-iron-select="_pageChanged" animate-initial-selection="true">

      <!-- slide 0 -->
      <!-- <neon-animatable id="blank" data-title="" class="fit">
      </neon-animatable> -->

      <!-- slide 1 -->
      <neon-animatable id="start" data-title="Add Contact" class="fit layout vertical center-center">
        <h1>Ready?</h1>
        <p>Tell other party to start scanning for &ldquo;<span>[[username]]</span>&rdquo; now.</p>
        <paper-button raised class="accent" on-tap="_onStartHandler">Start Scanning</paper-button>
        <div class="gutter"></div>
      </neon-animatable>

      <!-- slide 2 -->
      <neon-animatable id="scan" data-title="People nearby">
        <iron-selector attr-for-selected="index" on-tap="_onItemSelected" hidden>
          <iron-list items="{{listItems}}" as="item" class="fit">
            <template>
              <paper-material id="{{index}}" class="row">
                <div class="fit layout horizontal center">
                  <p class="truncate flex">[[item.username]]</p>
                  <iron-icon icon="chevron-right"></iron-icon>
                </div>
              </paper-material>
            </template>
          </iron-list>
        </iron-selector>
        <aside class="fit vertical layout center-center">
          <iron-icon icon="autorenew" class="rotating"></iron-icon>
          <p>Finding</p>
        </aside>
      </neon-animatable>

      <!-- slide 3 -->
      <neon-animatable id="pair" data-title="Verification">
        <main class="fit vertical layout center-center" hidden>
          <p>Does your contact request code match?</p>
          <h1 class="scratch">[[pairingCode]]</h1>
          <div class="layout horizontal">
            <paper-button class="accent-warn" on-tap="_onDeclineHandler"><iron-icon icon="cancel"></iron-icon> Decline</paper-button>
            <paper-button class="accent-default" on-tap="_onConfirmationHandler"><iron-icon icon="check-circle"></iron-icon> Confirm</paper-button>
          </div>
          <div class="gutter"></div>
        </main>
        <aside class="fit vertical layout center-center">
          <iron-icon icon="autorenew" class="rotating"></iron-icon>
          <p>Attempting to pair with <span>[[selectedItem.username]]</span></p>
          <div class="gutter"></div>
        </aside>
      </neon-animatable>

    </neon-animated-pages>

  </paper-header-panel>
</template>

<script>
Polymer({
  is: "modal-identity",

  behaviors: [
      Polymer.PaperDialogBehavior,
      Polymer.NeonAnimationRunnerBehavior,
      PageBehaviors.TreeTraversing,
      PageBehaviors.UIHelper,
    ],

  listeners: {
    'neon-animation-finish': '_onNeonAnimationFinish',
    // 'track': '_handleTrack'
  },

  properties: {
    username: {
      type: String,
      value: ""
    },
    title: {
      type: String,
      value: "",
      nofity: true
    },
    selectedPage: {
      type: String,
      value: "start",
      nofity: true
    },
    lastPage: {
      type: String,
    },
    listItems: {
      type: Array,
      value: [],
      notify: true
    },
    selectedItem : {
      type: Object,
      notify: true
    },
    taskScanning: {
      type: Object
    },
    taskPairing: {
      type: Object
    },
    pairingCode : {
      type: String,
      value: "123456",
      notify: true
    },
    toastText : {
      type: String,
      value: "",
      notify: true
    }
  },

  _setState: function() {
    this.username = myApp.username;
    this.set('title', "Add Contact");
  },

  _resetState: function() {
    this._stopAll();
    this.set('listItems', []);
    this._resetPageViews();
    this._gotoPageAtIndex(0);
    this.set('lastPage', null);
    this.set('selectedItem', null); 
  },

  _pageChanged: function(e) {
    var id = e.detail.item.id;
    console.log(this.localName + ' - page selection changed from:' + this.lastPage + ' to: ' + id);

    var title = "";
    // get selected page title attribute
    if (this.selectedPage) {
      title = this.querySelector('neon-animatable[id="'+this.selectedPage+'"]').getAttribute('data-title'); //e.detail.item.title;
      console.log("selectedPage: " + this.selectedPage + " title: " + title);
    }

    // last page
    if(this.lastPage && this.lastPage==="pair") {
      this._stopPairing();
    }
    this.lastPage = id;
    
    // do stuff for the page selected
    Polymer.dom(this.$.backButton).setAttribute("hidden",true);
    switch (id) {
      case "start":
        console.log("#1 start");
        break;
      case "scan":
        console.log("#2 scan");
        this._startScanning();
        break;
      case "pair":
        console.log("#3 pair");
        Polymer.dom(this.$.backButton).removeAttribute("hidden");
        if(this.selectedItem){
          //title += " with " + this.selectedItem.username;
          this._startPairing();
        } else {
          // TODO: show error view to user
        }
        break;
      default:
    }
    this.set('title', title); // update page title
  },

  _getPageIndex: function(pageName) {
    var parent = this.querySelector('neon-animated-pages');
    var children = parent.querySelectorAll('neon-animatable');
    for(var i=0; i<children.length; i++) {
      if(pageName === children[i].id) {
        return i;
      }
    }
    return -1; // return error not found 
  },

  _gotoPage: function(pageName) {
    if ( this._getPageIndex(pageName)>=0 ) {
      console.log("gotoPage: "+ pageName);
      this.set('selectedPage', pageName); //this.selectedPage = pageName;
    } else {
      console.log("Error, no page name:" + pageName);
    }
  },

  _gotoPageAtIndex: function(index) {
    var parent = this.querySelector('neon-animated-pages');
    var children = parent.querySelectorAll('neon-animatable');
    if (index <= children.length-1) {
      this._gotoPage( children[index].id );
    } else {
      console.log("Error: page index request out of range.");
    }
  },

  _onBackHandler: function(e) {
    var pageIndex = this._getPageIndex( this.selectedPage );
    if(pageIndex > 0) {
      this._resetSelectedPageView();
      this._gotoPageAtIndex(pageIndex-1);
    } else {
      console.log("Error, can't go back at index: " + pageIndex);
    }
  },

  _onStartHandler: function(e) {
    this.set('listItems', []); // clear list 
    this._gotoPage("scan");
  },

  _onItemSelected: function(e) {
    var selectedIndex = this.getParentAttribute(e.target, 'paper-material', 'id');
    if(selectedIndex!==false && selectedIndex>=0){
      this.set('selectedItem', this.listItems[selectedIndex]);
      console.log("selected #"+selectedIndex + " name:" + this.selectedItem.username + " id:" + this.selectedItem.id);
      this._stopScanning();

      // TODO: select person to pair with
      this._gotoPage("pair");
    }
  },

  _onConfirmationHandler: function(e) {
    console.log("TODO: add contact to private db");
  },

  _onDeclineHandler: function(e) {
    console.log("user declined positive match");
    this._onBackHandler();
  },

  _mockEvent: function() {
    var isAvailable = (Math.random() > 0.5);
    var isViewRequiringUpdate = false;

    if(isAvailable){
      // simulate available - add to list
      var username = faker.internet.userName();
      var id = faker.random.uuid();
      isViewRequiringUpdate = this._addPerson(id, username);
    } else if (this.listItems.length > 0) {
      // simulate unavailable - remove from list
      var index = Math.floor(Math.random() * this.listItems.length);
      var item = this.listItems[index];
      isViewRequiringUpdate = this._removePerson(item.id);
    }
    if(!isViewRequiringUpdate) {
      return;
    }
    // update view
    if(this.listItems.length>0) {
      this._showSelectedPageView("iron-selector"); // iron-list
    } else {
      this._showSelectedPageView("aside");
    }
  },

  _raiseParingRequest : function() {
    if (this.listItems.length > 0) {
      var peer = this.listItems[0];
      var text = "Verify code " + this.pairingCode + " sent from " + peer.username;
      console.log("*** raise pairing request ***\n" + text);
      this.set('toastText', text);
      var toast = document.querySelector('paper-toast');
      if( toast ){
        console.log("*** toast ***");
        toast.text = text;
        toast.duration = 8000;
        toast.show();
      }
    }
  },

  /* scanning */

  // start service
  _startScanning: function() {
    console.log("start discovery service...");
    if(!this.taskScanning) {
      this.taskScanning = setInterval(this._mockEvent.bind(this), 1000);
    }
    // simulate pairing request during scanning state
    setTimeout(this._raiseParingRequest.bind(this), 6000);
  },

  // stop service
  _stopScanning: function() {
    if(this.taskScanning) {
      console.log("stop discovery service");
      clearInterval(this.taskScanning);
      this.taskScanning = null;
    }
  },

  _addPerson: function(id, username) {
    console.log("+ person:"+username +" id:"+id);
    var item = {
        username : username,
        id : id
      };

    this.push('listItems', item);
    return true;
  },

  _removePerson: function(id) {
    var item;
    for(var i=0; i<this.listItems.length; i++) {
      item = this.listItems[i];
      if(id === item.id) {
        console.log("- person:"+item.username +" id:"+item.id);
        this.splice('listItems',i,1);
        return true;
      }
    }
    return false;
  },

  /* pairing */

  _startPairing: function() {
    if(!this.taskPairing) {
      this.taskPairing = setTimeout(function(){
        var randomCode = (""+Math.random()).substring(2,8); 
        console.log("pairing code generated: " + randomCode);
        this.set('pairingCode',randomCode);
        //this.hide( this.querySelector("aside") );
        //this.show( this.querySelector("main") );
        this._showSelectedPageView("main");
      }.bind(this), 3000); // simulate wait for an async request
    }
  },

  _stopPairing: function() {
    if(this.taskPairing) {
      console.log("stop pairing service");
      clearTimeout(this.taskPairing);
      this.taskPairing = null;
    }
  },

  // clean-up resources on close
  _stopAll: function() {
    this._stopScanning();
    this._stopPairing();
  },

  /* UI */

  // show only one child of selected page view
  _showSelectedPageView : function(elementTag) {
    var container = this.querySelector(".iron-selected");
    if(container) {
      console.log("show only element tag: "+ elementTag + " children: " + container.children.length);
      for(var i=0; i<container.children.length; i++) {
        this.hide(container.children[i]);
      }
      var element = container.querySelector(elementTag);
      if(element){
        this.show(element);
      }
    }
  },

  _resetSelectedPageView : function() {
    var container = this.querySelector(".iron-selected");
    if(container) {
      this.hideAllTags(["main","iron-selector"], container);
      this.showAllTags(["aside"], container);
    }
  },

  _resetPageViews: function() {
     this.hideAllTags(["main","iron-selector"]);
     this.showAllTags(["aside"]);
  },

  _handleTrack: function(e) {
    switch(e.detail.state) {
      case 'start':
        console.log('Tracking started!');
        break;
      case 'track':
        // console.log('Tracking in progress... dy:' + e.detail.dy);
        // console.log("this.style.top" + this.style.top);
        // this.style.top = e.detail.dy + 'px';
        break;
      case 'end':
        console.log('Tracking ended! dy:' + e.detail.dy );
        if(e.detail.dy > 100){
          this.close();
        }
        break;
    }
  },

  /* polymer behavior methods */

  _renderOpened: function() {
    this._setState(); // set state when opened

    if (this.withBackdrop) {
      this.backdropElement.open();
    }
    this.cancelAnimation(); // sweet hack to protect animation stack breaks due to double click
    this.playAnimation('entry');

    this._gotoPage("start");
  },

  _renderClosed: function() {
    this._resetState(); // reset state for next time

    if (this.withBackdrop) {
      this.backdropElement.close();
    }
    this.cancelAnimation(); // sweet hack to protect animation stack breaks due to double click
    this.playAnimation('exit');
  },

  _onNeonAnimationFinish: function() {
    console.log("*** _onNeonAnimationFinish ***");
    if (this.opened) {
      this._finishRenderOpened();
      this.style.top = '0px';
    } else {
      this._finishRenderClosed(); // this.style.display = 'none';
    }
  },

});
</script>
</dom-module>