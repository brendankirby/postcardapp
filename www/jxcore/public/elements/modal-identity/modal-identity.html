<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="/bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="/elements/behaviors/tree-traversing.html">
<link rel="import" href="/elements/behaviors/ui-helper.html">
<link rel="import" href="/elements/behaviors/multi-platform.html">

<dom-module id="modal-identity">

<template>
  <paper-header-panel>
    <paper-toolbar>
      <div id="leftToolbarButtons">
        <paper-icon-button id="prevButton" icon="arrow-back" on-click ="_onBackHandler" hidden></paper-icon-button>
      </div>
      <div id="appName">[[title]]</div>
      <div id="rightToolbarButtons">
        <div id="notifications" on-click="_onReadNotifications" class="ghost">
          <paper-icon-button id="notificationsButton" icon="social:notifications"></paper-icon-button>
          <div class="badge">[[listNotifications.unread]]</div>
          <!-- <paper-badge for="notificationsButton" label="!" class="icon"></paper-badge> -->
        </div>
        <paper-icon-button id="closeButton" icon="close" on-click="_onCloseHandler"></paper-icon-button>
      </div>
    </paper-toolbar>

    <!-- notifications panel -->
    <section id="notificationsPanel" class="fit" hidden>
      <article class="fit vertical layout center-center">
        <h1>Nothing to see here!</h1>
      </article>
      <iron-list items="{{listNotifications.rows}}" as="item" class="fit" hidden>
        <template>
          <paper-material id="{{index}}" class="row">
            <div class="fit layout horizontal center">
              <p class="truncate flex">[[item.message]]</p>
            </div>
          </paper-material>
        </template>
      </iron-list>
    </section>

    <!-- slide pages: -->
    <!-- NB: iOS8 memory leak when using animation attributes: entry-animation="slide-from-right-animation" exit-animation="slide-left-animation" -->
  	<neon-animated-pages class="fit" selected="{{selectedPage}}" attr-for-selected="id"  on-iron-select="_pageChanged" on-neon-animation-finish="_pageDidAnimate" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">

      <!-- slide page: user instructions -->
      <neon-animatable id="start" data-title="Add Contact" class="layout vertical center-center">
        <h1>Ready?</h1>
        <p>Ask other party to start scanning now.</p>
        <paper-button raised class="accent" on-click="_onStartHandler">Start Scanning</paper-button>
        <div class="gutter"></div>
        <p class="diminished">Your username is &ldquo;<span>[[username]]</span>&rdquo;</p>
      </neon-animatable>

      <!-- slide page: start scanning -->
      <neon-animatable id="scan" data-title="People nearby">
        <iron-selector attr-for-selected="index" on-click="_onItemSelected" hidden>
          <iron-list items="{{listItems}}" as="item" class="fit">
            <template>
              <paper-material id="{{index}}" class="row">
                <div class="fit layout horizontal center">
                  <p class="truncate flex">[[item.username]]</p>
                  <iron-icon icon="chevron-right"></iron-icon>
                </div>
              </paper-material>
            </template>
          </iron-list>
        </iron-selector>
        <aside class="fit vertical layout center-center">
          <iron-icon icon="autorenew" class="rotating"></iron-icon>
          <p>Finding</p>
        </aside>
      </neon-animatable>

      <!-- slide page: select contact -->
      <neon-animatable id="pair" data-title="Verification">
        <main class="fit vertical layout center-center" hidden>
          <h1>Ask <span>[[selectedItem.username]]</span></h1>
          <p>Does your code match?</p>
          <h1 class="scratch">[[pairingCode]]</h1>
          <!-- <p>sent from <span>[[username]]</span></p> -->
          <div class="layout horizontal">
            <paper-button class="accent-warn" on-click="_onDeclineHandler"><iron-icon icon="cancel"></iron-icon> Decline</paper-button>
            <paper-button class="accent-default" on-click="_onConfirmationHandler"><iron-icon icon="check-circle"></iron-icon> Confirm</paper-button>
          </div>
          <div class="gutter"></div>
        </main>
        <aside class="fit vertical layout center-center">
          <iron-icon icon="autorenew" class="rotating"></iron-icon>
          <p>Attempting to pair with <span>[[selectedItem.username]]</span></p>
          <div class="gutter"></div>
        </aside>
      </neon-animatable>

      <!-- slide page: save user contact -->
      <neon-animatable id="save" data-title="Save contact">
        <form is="iron-form" class="inset" hidden>
          <paper-input name="username" label="Username" bind-value="{{petName::input}" prevent-invalid-input allowed-pattern="[A-Za-z0-9_\.]" always-float-label error-message="{{errorUsername}}" required></paper-input>
          <input is="iron-input" name="_id" bind-value="{{selectedItem.id::input}}" type="hidden" />
          <input is="iron-input" name="_username" bind-value="{{selectedItem.username::input}}" type="hidden" />
          <div class="alignCenter">
            <paper-button class="accent" raised on-click="_onSubmitForm">Save</paper-button>
          </div>
        </form>
        <aside class="fit vertical layout center-center">
          <iron-icon icon="autorenew" class="rotating"></iron-icon>
          <p>One moment please</p>
          <div class="gutter"></div>
        </aside>
      </neon-animatable>

    </neon-animated-pages>

  </paper-header-panel>
</template>

<script>
'use strict';
Polymer({
  is: "modal-identity",

  attached: function() {
    this.noCancelOnOutsideClick = true;
    this.withBackdrop = true;
  },

  behaviors: [
      // Polymer.PaperDialogBehavior,
      Polymer.IronOverlayBehavior,
      Polymer.NeonAnimationRunnerBehavior,
      PageBehaviors.TreeTraversing,
      PageBehaviors.UIHelper,
      PageBehaviors.MultiPlatform
    ],

  listeners: {
    'neon-animation-finish': '_onNeonAnimationFinish',
    'iron-form-invalid': '_formInvalid',
    'iron-form-submit': '_formSubmit',
    'iron-form-response': '_formResponse',
    'iron-form-error': '_formError'
  },

  properties: {
    username: {
      type: String,
      value: ""
    },
    title: {
      type: String,
      value: ""
    },
    selectedPage: {
      type: String,
      value: "start"
    },
    lastPage: {
      type: String,
    },
    listItems: {
      type: Array,
      value: []
    },
    selectedItem : {
      type: Object,
      notify: true
    },
    taskScanning: {
      type: Object
    },
    taskPairing: {
      type: Object
    },
    taskNotification: {
      type: Object
    },
    pairingCode : {
      type: String,
      value: "123456"
    },
    toastText : {
      type: String,
      value: ""
    },
    listNotifications : {
      type: Object,
      notify: true,
      value: {
        rows: [],
        unread: 0
      }
    },
    errorUsername: {
      type: String,
      value: "Please enter unique username."
    },
    _isSaving: false,
  },

  ready: function() {
    console.log(this.localName + ' ready page:' + this.selectedPage);
    this.lastPage = this.selectedPage; // set last page
  },

  _setState: function() {
    this.username = myApp.username;
    this.set('title', this._getSelectedPageTitle()); // update page title 
    if(this._getSelectedPageIndex()>0) {
      this._gotoPageAtIndex(0); 
    }
  },

  _resetState: function() {
    this._stopAll();
    this.set('listItems', []);
    this._resetPageViews();
    this.hideSelector("#notificationsPanel");
    this.set('lastPage', null);
    this.set('selectedItem', null);
  },

  _getSelectedPageTitle: function() {
    var titleAttribute = 'data-title';
    if (this.selectedPage) {
      return this.querySelector('neon-animatable[id="'+this.selectedPage+'"]').getAttribute(titleAttribute);
    }
    return "Add Contact"; // default title
  },

  _pageChanged: function(e) {
    //var id = e.detail.item.id;
    console.log("#" + this.lastPage + " -> selectedPage: #" + this.selectedPage);
    this.set('title', this._getSelectedPageTitle()); // update page title

    // stop active processes on last page 
    if(this.lastPage==="pair") {
      //Polymer.dom(this.$.prevButton).setAttribute("hidden",true);
      this._stopPairing();
    } else if(this.lastPage==="scan"){
      this._stopScanning();
    }

    // hide notifications panel
    this.hideSelector("#notificationsPanel");

    // detect if back button is needed?
    if(this.selectedPage && this._getPageIndex(this.selectedPage) > 0) {
      Polymer.dom(this.$.prevButton).removeAttribute("hidden");
    } else {
      Polymer.dom(this.$.prevButton).setAttribute("hidden",true);
    }

    //this._pageDidAnimate(); // NB: only call if no animation start/finish attributes set
  },

  _pageDidAnimate: function() {
    // reset last page view state
    if(this.lastPage) {
      console.log('#'+this.lastPage + " page did disappear");
      this._resetPageView( this.querySelector('#'+this.lastPage) );
    }
    this.lastPage = this.selectedPage;

     // do stuff for the page selected
    switch (this.selectedPage) {
      case "start":
        console.log("#1 start");
        break;
      case "scan":
        console.log("#2 scan");
        this._startScanning();
        break;
      case "pair":
        console.log("#3 pair");
        if(this.selectedItem){
          this._startPairing();
        }
        break;
      case "save":
        console.log("#4 save");
        this._checkUsernameAvailable();
        break;
      default:
    }
  },

  _getPageIndex: function(pageName) {
    var parent = this.querySelector('neon-animated-pages');
    var children = parent.querySelectorAll('neon-animatable');
    var i = children.length;
    while (i--) {
      if(pageName === children[i].id) {
        return i;
      }
    }
    return -1; // return error not found 
  },

  _getSelectedPageIndex: function() {
    var parent = this.querySelector('neon-animated-pages');
    var children = parent.querySelectorAll('neon-animatable');
    var i=0, l=children.length;
    while (i<l) {
      if( children[i].classList.contains("iron-selected") ) {
        return i;
      }
      i++;
    }
    return -1; // return no selection
  },

  _gotoPage: function(pageName) {
    if ( this._getPageIndex(pageName)>=0 ) {
      console.log("gotoPage: "+ pageName);
      this.set('selectedPage', pageName); //this.selectedPage = pageName;
    } else {
      console.log("Error, no page name:" + pageName);
    }
  },

  _gotoPageAtIndex: function(index) {
    var parent = this.querySelector('neon-animated-pages');
    var children = parent.querySelectorAll('neon-animatable');
    if (index <= children.length-1) {
      this._gotoPage( children[index].id );
    } else {
      console.log("Error, page index request out of range.");
    }
  },

  _goPrevPage: function() {
    var pageIndex = this._getPageIndex( this.selectedPage );
    if(pageIndex > 0) {
      this._gotoPageAtIndex(pageIndex-1);
    } else {
      console.log("Error, can't go to previous page. @" + pageIndex);
    }
  },

  // try this.$.pages.selectNext()
  _goNextPage: function() {
    var pageIndex = this._getPageIndex( this.selectedPage );
    var totalPages = this.querySelector('neon-animated-pages').querySelectorAll('neon-animatable').length;
    if(pageIndex+1 < totalPages) {
      this._gotoPageAtIndex(pageIndex+1);
    } else {
      console.log("Error, can't go to next page. @" + pageIndex);
    }
  },

  _onCloseHandler: function(e) {
    this.close();
  },

  _onBackHandler: function(e) {
    this._goPrevPage();
  },

  _onStartHandler: function(e) {
    this.set('listItems', []); // clear list 
    this._goNextPage();
  },

  _onItemSelected: function(e) {
    var selectedIndex = this.getParentAttribute(e.target, 'paper-material', 'id');
    if(selectedIndex!==false && selectedIndex>=0){
      this.set('selectedItem', this.listItems[selectedIndex]);
      console.log("selected #"+selectedIndex + " name:" + this.selectedItem.username + " id:" + this.selectedItem.id);
      this._stopScanning();

      // select person to pair with
      this._goNextPage(); // this._gotoPage("pair");
    }
  },

  _onConfirmationHandler: function(e) {
    console.log("TODO: add contact to private db");
    this._goNextPage(); // this._gotoPage("save");
  },

  _onDeclineHandler: function(e) {
    console.log("user declined positive match");
    this._onBackHandler();
  },

  /* scanning */

  _startScanning: function() {
    console.log("start discovery service...");
    this._updateScanningView();

    // runs indefinately until view changed
    if(!this.taskScanning) {
      this.taskScanning = setInterval(this._mockScanningEvent.bind(this), 2000);
    }

    //simulate pairing request during scanning state
    if(!this.taskNotification) {
      this.taskNotification = setTimeout(this._mockPairingNotification.bind(this), 7000);
      //this.taskNotification = this.async(this._mockPairingNotification, null, 7000);
    }
  },

  _stopScanning: function() {
    if(this.taskScanning) {
      console.log("stop discovery service");
      clearInterval(this.taskScanning);
      this.taskScanning = null;
    }
  },

  _mockScanningEvent: function() {
    console.log("* scanning...");
    var isAvailable = (Math.random() > 0.5);
    var isViewRequiringUpdate = false;

    if(isAvailable || this.listItems.length==0){
      // simulate peer available - add to list
      var username = faker.internet.userName();
      var id = faker.random.uuid();
      isViewRequiringUpdate = this._addPerson(id, username);
    } else if (this.listItems.length > 0) {
      // simulate peer unavailable - remove from list
      var index = Math.floor(Math.random() * this.listItems.length);
      var item = this.listItems[index];
      isViewRequiringUpdate = this._removePerson(item.id);
    }

    // update view state if needed
    if(isViewRequiringUpdate) {
      this._updateScanningView();
    }
  },

  _updateScanningView: function() {
    if(this.listItems.length>0) {
      this._showSelectedPageView("iron-selector"); // iron-list
    } else {
      this._showSelectedPageView("aside");
    }
  },

  _addPerson: function(id, username) {
    //console.log("+ person:"+username +" id:"+id);
    var item = {
        username : username,
        id : id
      };

    this.push('listItems', item);
    return true;
  },

  _removePerson: function(id) {
    var item;
    for(var i=0; i<this.listItems.length; i++) {
      item = this.listItems[i];
      if(id === item.id) {
        //console.log("- person:"+item.username +" id:"+item.id);
        this.splice('listItems',i,1);
        return true;
      }
    }
    return false;
  },

  /* notifications */

  _mockPairingNotification : function() {
    console.log("* notifying...");
    if (this.listItems.length > 0) {
      var peer = this.listItems[0];
      var code = this.pairingCode; //this._generateCode();
      var message = "Verify code " + code + " sent from " + peer.username;
      console.log("raised pairing request");
      this._showToastNotification(message, 8);
    }
    this._stopNotification(); // clean-up
  },

  _stopNotification : function() {
    if(this.taskNotification) {
      console.log("stop notification service");
      clearTimeout(this.taskNotification);
      this.taskNotification = null;
    }
  },

  _showToastNotification : function(message, secs) {
    this.set('toastText', message);
    this._addNotification(message);
    var toast = document.querySelector('paper-toast');
    if( toast ){
      console.log("*** show toast ***\n" + message);
      toast.text = message;
      toast.duration = secs*1000;
      toast.show();
    }
  },

  _addNotification : function(message) {
    this.unshift('listNotifications.rows', {message:message,isRead:false});
    if(this.listNotifications.unread) {
      var unread = this.listNotifications.unread+1;
      console.log("Add unread notification:" + unread );
      this.set('listNotifications.unread', unread );
    } else {
      this.set('listNotifications.unread', 1);
    }

    this.querySelector('#notifications').classList.remove("ghost"); //this.show( this.querySelector('#notifications') );
  },

  /* pairing */

  _startPairing: function() {
    // simulate wait for an async callback
    if(!this.taskPairing) {
      this.taskPairing = setTimeout(this._mockPairing.bind(this), 3000);
      //this.taskPairing = this.async(this._mockPairing, 3000);
    }
  },

  _stopPairing: function() {
    if(this.taskPairing) {
      console.log("stop pairing service");
      clearTimeout(this.taskPairing);
      this.taskPairing = null;
      //this.cancelAsync(this.taskPairing);
    }
  },

  _mockPairing: function() {
    console.log("* pairing...");
    var code = this._generateCode(); 
    console.log("random pairing code generated: " + code);
    this.set('pairingCode', code);
    this._showSelectedPageView("main");
    this._stopPairing(); // clean-up
  },

  // returns random 6 digit string
  _generateCode: function() {
    return (""+Math.random()).substring(2,8); 
  },

  /* form */

  _onSubmitForm: function() {
    var isSuccess = true;  
    console.log("TODO: Verify and save contact's unique username to private db...");
    // TODO: hide form and show spinner
    this.querySelector('form').submit();
  },

  _checkUsernameAvailable: function() {
    // TODO check if username is unique...
    var suggestedUsername = 'x' + this.selectedItem.username + 'x';
    console.log("suggested username available: " + suggestedUsername);

    //this.set('selectedItem.username', suggestedUsername);
    var input = this.querySelector('input[name="username"]');
    if(input) {
      input.value = suggestedUsername;
      this.autoFocus(input); // UX send focus to textarea
    }

    this._showSelectedPageView("form");
  },

  _formInvalid: function(e) {
    // notify user what went wrong on client
    console.log('Form invalid');
  },
  _formSubmit: function(e) {
    console.log("Form was submitted");
    console.log(e.detail);
    var contactId = e.detail._id;
    var username = e.detail.username;
    console.log("=> _id:"+contactId + " username:"+username);
    this._saveContact(contactId, username); // <-- save
  },
  _formResponse: function(e) {
    console.log("Server Response:", e.detail);
    //this.close(); // dismiss modal when done
  },
  _formError: function(e) {
    console.log("Form Error:", e.detail);
  },

  /* ajax */

  _saveContact: function(contactId, username) {
    var self = this;
    this._isSaving = true;
    console.log("=> Save contact:" + username + " id:"+ contactId);
    $.ajax({
        url: myApp._url + contactId,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ 
          username: username
        }),
        dataType: 'json',
        error: function(jqXHR, textStatus, errorThrown) {
          console.log('@ error in save Contact ' + JSON.stringify(jqXHR) + ' ' + textStatus + ' ' + errorThrown);
          alert("Error saving Contact");
        },
        success: function(data, textStatus, jqXHR) {
          console.log("@ saved Contact - " + textStatus);
          console.log(data);
          // if 'ok' update client UI else alert user with error
          if(data.ok && data.ok===true) {
            console.log("OK", textStatus);
            self._isSaving = false;
            // TODO: toast alert with saved contact 
            self.close(); // dismiss modal when done (unless we want to add another?)
          } else {
            alert("Save Contact error");
          }
        }
    });
  },

  /*  clean-up resources on close */

  _stopAll: function() {
    this._stopScanning();
    this._stopPairing();
  },

  /* UI */

  _onReadNotifications : function(e) {
    console.log("Read notifications");
    this.toggleVisibility("#notificationsPanel");
    //console.log(this.listNotifications);
    if(this.listNotifications.rows && this.listNotifications.rows.length > 0) {
      this.show( this.querySelector("#notificationsPanel iron-list") );
      this.hide( this.querySelector("#notificationsPanel article") );
      // needs a draw call after hidden state
      this.querySelector("#notificationsPanel iron-list").fire('resize');
    } else {
      this.hide( this.querySelector("#notificationsPanel iron-list") );
      this.show( this.querySelector("#notificationsPanel article") );
    }
  },

  // manages view state by passing only one child to show within the selected page view element
  _showSelectedPageView : function(elementTag) {
    var container = this.querySelector(".iron-selected");
    if(container) {
      //console.log("show only element tag: "+ elementTag + " children: " + container.children.length);
      for(var i=0; i<container.children.length; i++) {
        this.hide(container.children[i]);
      }
      var element = container.querySelector(elementTag);
      if(element){
        this.show(element);
      }
    }
  },

  _resetPageView : function(element) {
    if(element && element instanceof Node) {
      this.hideAllSelectors(["main","iron-selector"], element);
      this.showAllSelectors(["aside"], element);
    }
  },

  _resetPageViews: function() {
     this.hideAllSelectors(["main","iron-selector"]);
     this.showAllSelectors(["aside"]);
  },

  /* animation behavior methods */

  _renderOpened: function() {
    this._setState(); // set state when opened before playing entry animation

    if (this.withBackdrop) {
      this.backdropElement.open();
    }
    this.cancelAnimation(); // sweet hack to prevent animation stack breaking due to double click
    this.playAnimation('entry');
  },

  _renderClosed: function() {
    if (this.withBackdrop) {
      this.backdropElement.close();
    }
    this.cancelAnimation(); // sweet hack to prevent animation stack breaking due to double click
    this.playAnimation('exit');
  },

  _onNeonAnimationFinish: function() {
    if (this.opened) {
      console.log("*** modal opened ***");
      this._finishRenderOpened();
    } else {
      this._finishRenderClosed();
      this._resetState(); // reset state for next time
      console.log("*** modal closed ***");
    }
  }

});
</script>
</dom-module>