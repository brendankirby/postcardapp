<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="/elements/behaviors/modal-pages.html">
<link rel="import" href="/elements/behaviors/ui-helper.html">
<link rel="import" href="/elements/behaviors/tree-traversing.html">

<dom-module id="page-scan">

<template>
	<iron-selector attr-for-selected="index" on-click="_onItemSelected" hidden>
    <iron-list items="{{listItems.peers}}" as="item" class="fit">
      <template>
        <paper-material id="{{index}}" class="row">
          <div class="fit layout horizontal center">
            <p class="truncate flex">[[item.peerFriendlyName]]</p>
            <iron-icon icon="chevron-right"></iron-icon>
          </div>
        </paper-material>
      </template>
    </iron-list>
  </iron-selector>
  <!-- spinner -->
  <aside class="fit vertical layout center-center">
    <iron-icon icon="autorenew" class="rotating"></iron-icon>
    <p>Finding</p>
  </aside>
</template>

<script>
'use strict';
Polymer({
  is: "page-scan",
  behaviors: [
      Polymer.NeonAnimatableBehavior,
      PageBehaviors.ModalPages,
      PageBehaviors.UIHelper,
      PageBehaviors.TreeTraversing,
    ],
  properties: {
    listItems: {
      type: Object,
      notify: true
    },
    isStarted: {
      type: Boolean,
      value: false
    },
    task: {
      type: Object
    }
  },
  setup : function() {
    console.log(this.localName + ' setup');
    this.set('listItems', {});
  },
  start : function() {
    console.log(this.localName + ' start');
    this._updateView();
    this._putIdentityExchange();
  },
  stop : function() {
    console.log(this.localName + ' stop');
    if(this.isStarted) {
      console.log("Stop the identity exchange process...");
      this._deleteIdentityExchange();
    }
    if(this.task) {
      console.log("Stop identity exchange task");
      clearInterval(this.task);
      this.task = null;
    }
  },

  /* scan */

  _onItemSelected: function(e) {
    var selectedIndex = this.getParentAttribute(e.target, 'paper-material', 'id');
    if (selectedIndex!==false && selectedIndex>=0) {
      var selectedItem = this.listItems.peers[selectedIndex];
      // stop scanning once selected
      this.stop();
      // person selected to pair with
      this.modalNextFire(selectedItem);
    }
  },

  /* rest api */

  _putIdentityExchange : function() {
    $.ajax({
      context : this,
      method : 'PUT',
      url : myApp.webview + 'IdentityExchange',
      contentType: 'application/json',
      data: JSON.stringify({ 
        peerFriendlyName: myApp.username
      }),
      timeout : 4000
    }).fail( function( jqXHR, textStatus, errorThrown ){
      alert("Error, could not get device identity. " + textStatus);
      // TODO: go back and try again
    }).done( function(data, textStatus, jqXHR){
      console.log("putIdentityExchange:" + textStatus);
      this.isStarted = true;
      if(!this.task && this.isSelected()) {
        console.log("Start discovery service...");
        this.task = setInterval(this._getIdentityExchange.bind(this), 2000);
      }
    });
  },

  _deleteIdentityExchange : function() {
    $.ajax({
      context : this,
      method : 'DELETE',
      url : myApp.webview + 'IdentityExchange',
      timeout : 4000
    }).fail( function( jqXHR, textStatus, errorThrown ){
      alert("Error, could not delete device identity. " + textStatus);
    }).done( function(data, textStatus, jqXHR){
      console.log("deleteIdentityExchange:" + textStatus);
      this.isStarted = false;
    });
  },

  _getIdentityExchange : function() {
    this.request = $.ajax({
      context : this,
      method : 'GET',
      url : myApp.webview + 'IdentityExchange',
      data : 'json',
      timeout : 4000
    }).fail( function( jqXHR, textStatus, errorThrown ){
      alert("Error, could not get device identity. " + textStatus);
      // go back and try again
    }).done( function(data, textStatus, jqXHR){
      console.log("getIdentityExchange:" + textStatus);
      console.log(data);
      if (data) {
        this.set('listItems', data);
        this._updateView();
      }
    });
  },

  _updateView: function() {
    if(this.listItems.peers && this.listItems.peers.length>0) {
      this.showOnlySelector("iron-selector"); // show list
    } else {
      this.showOnlySelector("aside"); // show spinner
    }
  },

});
</script>
</dom-module>